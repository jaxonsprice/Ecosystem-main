"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);
var DeviceCertification_exports = {};
__export(DeviceCertification_exports, {
  DeviceCertification: () => DeviceCertification
});
module.exports = __toCommonJS(DeviceCertification_exports);
var import_CertificationDeclaration = require("#certificate/kinds/CertificationDeclaration.js");
var import_general = require("#general");
var import_AttestationCertificateManager = require("./AttestationCertificateManager.js");
/**
 * @license
 * Copyright 2022-2025 Matter.js Authors
 * SPDX-License-Identifier: Apache-2.0
 */
class DeviceCertification {
  #crypto;
  #privateKey;
  #certificate;
  #intermediateCertificate;
  #declaration;
  #construction;
  get construction() {
    return this.#construction;
  }
  get certificate() {
    return this.#assertInitialized().certificate;
  }
  get intermediateCertificate() {
    return this.#assertInitialized().intermediateCertificate;
  }
  get declaration() {
    return this.#assertInitialized().declaration;
  }
  constructor(crypto, config, product) {
    this.#crypto = crypto;
    let configProvider;
    if (typeof config === "function") {
      configProvider = config;
    } else if (config) {
      configProvider = () => config;
    } else {
      configProvider = async () => {
        if (product === void 0) {
          throw new import_general.ImplementationError(`Cannot generate device certification without product information`);
        }
        const paa = await import_AttestationCertificateManager.AttestationCertificateManager.create(crypto, product.vendorId);
        const { keyPair: dacKeyPair, dac } = await paa.getDACert(product.productId);
        return {
          privateKey: (0, import_general.PrivateKey)(dacKeyPair.privateKey),
          certificate: dac,
          intermediateCertificate: await paa.getPAICert(),
          declaration: await import_CertificationDeclaration.CertificationDeclaration.generate(crypto, product.vendorId, product.productId)
        };
      };
    }
    this.#construction = (0, import_general.Construction)(this, async () => {
      const config2 = await configProvider();
      this.#privateKey = config2.privateKey instanceof Uint8Array ? (0, import_general.PrivateKey)(config2.privateKey) : config2.privateKey;
      this.#certificate = config2.certificate;
      this.#intermediateCertificate = config2.intermediateCertificate;
      this.#declaration = config2.declaration;
    });
  }
  async sign(session, data) {
    const { privateKey } = this.#assertInitialized();
    const signature = await this.#crypto.signEcdsa(privateKey, [data, session.attestationChallengeKey]);
    return signature;
  }
  /**
   * Makes sure that the device certification is initialized and construction is completed and returns "Non-undefined"
   * values
   */
  #assertInitialized() {
    this.#construction.assert();
    if (this.#certificate === void 0 || this.#intermediateCertificate === void 0 || this.#declaration === void 0 || this.#privateKey === void 0) {
      throw new import_general.InternalError(
        `Device certification not initialized while trying to access it. This should never happen.`
      );
    }
    return {
      certificate: this.#certificate,
      intermediateCertificate: this.#intermediateCertificate,
      declaration: this.#declaration,
      privateKey: this.#privateKey
    };
  }
}
//# sourceMappingURL=DeviceCertification.js.map
